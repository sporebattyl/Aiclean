# Roo AI Cleaning Assistant v2.0 - Architecture Document

## Overview

Version 2.0 represents a complete evolution from a single-function tool to a robust, multi-faceted, and intelligent home management assistant. The architecture supports stateful awareness, automatic task completion tracking, multi-zone management, dynamic notifications, and a comprehensive user interface.

## Core Architectural Principles

1. **Multi-Zone Architecture**: Support for multiple independent rooms/zones
2. **Stateful Task Management**: Persistent tracking with automatic completion detection
3. **Modular Design**: Loosely coupled components for maintainability
4. **Event-Driven**: Asynchronous processing with proper event handling
5. **Data-Driven UI**: Real-time updates and comprehensive analytics

## System Components

### 1. Core Engine (`core/`)
- **ZoneManager**: Manages multiple zones and their configurations
- **TaskTracker**: Handles stateful task management and completion detection
- **AIAnalyzer**: Enhanced AI analysis with comparison capabilities
- **StateManager**: Persistent state management and database operations

### 2. Data Layer (`data/`)
- **Database**: SQLite database with proper schema design
- **Models**: Data models for zones, tasks, history, and metrics
- **Repositories**: Data access layer with proper abstractions

### 3. Notification System (`notifications/`)
- **NotificationEngine**: Configurable notification delivery
- **PersonalityEngine**: Multiple personality modes for messages
- **TemplateManager**: Message templates and formatting

### 4. Frontend (`frontend/`)
- **LovelaceCard**: Comprehensive dashboard card
- **Components**: Reusable UI components
- **Services**: Frontend data services and API communication

### 5. API Layer (`api/`)
- **RESTful API**: For frontend communication
- **WebSocket**: Real-time updates
- **Authentication**: Secure API access

## Database Schema

### Tables

#### zones
```sql
CREATE TABLE zones (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    camera_entity_id TEXT NOT NULL,
    enabled BOOLEAN DEFAULT 1,
    notification_enabled BOOLEAN DEFAULT 1,
    personality_mode TEXT DEFAULT 'concise',
    update_frequency INTEGER DEFAULT 60,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### tasks
```sql
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    zone_id INTEGER NOT NULL,
    description TEXT NOT NULL,
    status TEXT DEFAULT 'pending', -- pending, completed, auto_completed, ignored
    confidence_score REAL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    auto_completed_at TIMESTAMP,
    FOREIGN KEY (zone_id) REFERENCES zones (id)
);
```

#### task_history
```sql
CREATE TABLE task_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    zone_id INTEGER NOT NULL,
    analysis_id TEXT NOT NULL,
    cleanliness_score INTEGER,
    image_path TEXT,
    tasks_detected INTEGER,
    tasks_completed INTEGER,
    analysis_duration REAL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (zone_id) REFERENCES zones (id)
);
```

#### ignore_rules
```sql
CREATE TABLE ignore_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    zone_id INTEGER NOT NULL,
    rule_type TEXT NOT NULL, -- object, area, keyword
    rule_value TEXT NOT NULL,
    enabled BOOLEAN DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (zone_id) REFERENCES zones (id)
);
```

#### performance_metrics
```sql
CREATE TABLE performance_metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    zone_id INTEGER NOT NULL,
    metric_date DATE NOT NULL,
    tasks_created INTEGER DEFAULT 0,
    tasks_completed INTEGER DEFAULT 0,
    tasks_auto_completed INTEGER DEFAULT 0,
    avg_cleanliness_score REAL,
    completion_rate REAL,
    FOREIGN KEY (zone_id) REFERENCES zones (id),
    UNIQUE(zone_id, metric_date)
);
```

## Key Features Implementation

### 1. Stateful Task Management

The system maintains a comparison between current and previous analyses:

```python
class TaskTracker:
    def compare_analyses(self, current_tasks, previous_tasks, zone_id):
        # Compare current vs previous task lists
        # Auto-complete tasks no longer detected
        # Track new tasks
        # Update confidence scores
```

### 2. Multi-Zone Support

Each zone operates independently with its own:
- Camera entity
- Task list
- Notification settings
- Ignore rules
- Performance metrics

### 3. Notification Engine

Configurable personality modes:
- **Concise**: "Living Room: 3 tasks remaining."
- **Snarky**: "The couch is still waiting for you to pick up those clothes."
- **Encouraging**: "You're doing great! Just 3 more tasks to go!"

### 4. Performance Analytics

Track and visualize:
- Task completion rates over time
- Average cleanliness scores
- Task creation vs completion trends
- Zone-specific performance metrics

## API Design

### REST Endpoints

```
GET /api/zones - List all zones
POST /api/zones - Create new zone
PUT /api/zones/{id} - Update zone
DELETE /api/zones/{id} - Delete zone

GET /api/zones/{id}/tasks - Get zone tasks
POST /api/zones/{id}/tasks/{task_id}/complete - Mark task complete

GET /api/zones/{id}/metrics - Get zone performance metrics
GET /api/zones/{id}/history - Get analysis history

POST /api/zones/{id}/ignore-rules - Add ignore rule
DELETE /api/ignore-rules/{id} - Remove ignore rule
```

### WebSocket Events

```
zone_updated - Zone configuration changed
task_completed - Task marked as complete
analysis_complete - New analysis finished
metrics_updated - Performance metrics updated
```

## Configuration Schema v2.0

```yaml
name: "Roo AI Cleaning Assistant"
version: "2.0.0"
slug: "aicleaner"
description: "AI-powered multi-zone home management assistant"
url: "https://github.com/sporebattyl/Aiclean"
arch: [aarch64, amd64, armv7]
startup: "application"
boot: "auto"
init: false
homeassistant_api: true
ingress: true
panel_icon: "mdi:robot-vacuum"
panel_title: "Roo Assistant"

schema:
  gemini_api_key: password
  default_personality: list(concise|snarky|encouraging)?
  global_notifications: bool?
  database_path: str?
  log_level: list(DEBUG|INFO|WARNING|ERROR)?

options:
  default_personality: "concise"
  global_notifications: true
  database_path: "/data/roo.db"
  log_level: "INFO"
```

## File Structure v2.0

```
aicleaner/
├── core/
│   ├── __init__.py
│   ├── zone_manager.py
│   ├── task_tracker.py
│   ├── ai_analyzer.py
│   └── state_manager.py
├── data/
│   ├── __init__.py
│   ├── database.py
│   ├── models.py
│   └── repositories.py
├── notifications/
│   ├── __init__.py
│   ├── engine.py
│   ├── personalities.py
│   └── templates.py
├── api/
│   ├── __init__.py
│   ├── routes.py
│   ├── websocket.py
│   └── auth.py
├── frontend/
│   ├── card/
│   │   ├── roo-card.js
│   │   ├── components/
│   │   └── styles/
│   └── www/
├── migrations/
│   ├── 001_initial_schema.sql
│   └── 002_add_metrics.sql
├── tests/
├── config.yaml
├── Dockerfile
├── requirements.txt
└── run.sh
```

## Migration Strategy

1. **Backward Compatibility**: v1.0 configurations will be automatically migrated
2. **Data Migration**: Existing sensor data will be preserved and enhanced
3. **Gradual Rollout**: New features can be enabled incrementally
4. **Fallback Mode**: System can operate in v1.0 compatibility mode if needed

## Next Steps

1. Implement database schema and migrations
2. Refactor core components for multi-zone support
3. Build the enhanced AI analysis engine
4. Develop the notification system
5. Create the comprehensive Lovelace card
6. Implement performance analytics
7. Add comprehensive testing
8. Update documentation
